<!-- <?xml version="1.0" encoding="UTF-8"?>-->

{# dara xml for RESOURCES
=========================
schema and example files:
http://www.da-ra.de/en/technical-information/doi-registration/

actually generated by macros: #}
{% import 'macros/dara_metadata.xml' as macros %}


{% set pkg = h.dara_pkg() %}
{% set dara_authors = h.dara_authors('res', data) %}

{% set res = h.dara_resource() %}
{% set url = h.dara_resource_url(res.url) %}


{# {% set debug = h.dara_debug(res) %} #}

<resource xmlns="http://da-ra.de/schema/kernel-4"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://da-ra.de/schema/kernel-4 http://www.da-ra.de/fileadmin/media/da-ra.de/Technik/4.0/dara.xsd">

<resourceType>{{ h.resource_type(res.dara_res_preselection) }}</resourceType>
{{ macros.resourceIdentifier(res.id, res.dara_currentVersion)}}

{# 1. title #}
{# CKAN does not enforce a title for resources. As long as we do not have validation,
we need to make sure here, that dara gets a title #}
{% set name = res.name or 'Untitled' %}
{{ macros.titles(name, 'en') }}

{# 2. other titles #}
{#XXX not implemented in resources
{{ macros.otherTitles('en', pkg.dara_OtherTitle or None, pkg.dara_OtherTitleType or None) }}
#}

{# TODO 3. collective title  #}

{# 4. creators  TODO: 4.2 institution #}
{#XXX for now we take the authors given in the collection here #}
{# if this is for a resource and there is no author, the authors for the article should be used. #}
<creators>
{% if not h.hide_from_reviewer(pkg) %}
    {% for author in dara_authors %}
        {{ macros.creator(author) }}
    {% endfor %}
{% else %}
    <creator>
        <person>
            <firstName>Name</firstName>
            <lastName>Withheld</lastName>
        </person>
    </creator>
{% endif %}
</creators>

{# 8. URL, 9. DOI proposal #}
{{ macros.doi(url, h.res_doi(res)) }}

{# *12.publication date #}
{{ macros.publicationDate(res.dara_PublicationDate or pkg.dara_PublicationDate) }}

{# *28/29 availability controlled/free #}
{% set av = res.dara_Availabilitycontrolled or 'Download' %}
{% if av in ['1', '2', '3', '4', '5'] %}
    {% set av = h.av_transform(av) %}
{% endif %}
{{ macros.availability(av or 'Download') }}

{# 30. rights #}
{{ macros.rights() }}



{# 11. resource language #}
{#XXX not implemented for resources #}
{{ macros.resourceLanguage(res.dara_language or None) }}


{# 17. description #}
{% if res.description %}
    {{ macros.description(res.description) }}
{% endif %}

{# XXX controlled not implemented yet; can have multiple entries #}
{#  18. geographic coverage controlled/free #}
{{ macros.geographicCoverages('en', res.dara_geographicCoverage or None, res.dara_geographicCoverageFree or None) }}

{# 19. sampled universe #}
{#XXX we are using 'None' as fallback since the schema is not correct here.
dara expects content, but schema does not force it #}
{{ macros.universes('en', res.dara_universeSampled or None) }}

{# 20. sampling #}
{#XXX not implemented for resources #}
{{ macros.samplings('en', res.dara_Sampling or None) }} {#XXX lang not implemented #}

{# 21. temporalCoverage #}
{{ macros.temporalCoverageFree(res.dara_temporalCoverageFree or None, res.dara_temporalCoverageFormal or None, res.dara_temporalCoverageFormal_end or None, h) }}


{# 26. Dataset, only relevant for resources #}
<dataSets>
    <dataSet>
        {% if res.dara_numberUnits %}
            {% set v = res.dara_unitType %}
            {% if v in ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13'] %}
                {% set v = h.unit_type_transform(v) %}
            {% endif %}
            <unitType>{{ v }}</unitType>
            <numberUnits>{{ res.dara_numberUnits }}</numberUnits>
        {% endif %}
        {% if res.dara_numberVariables %}
            <numberVariables>{{ res.dara_numberVariables }}</numberVariables>
        {% endif %}
        {% if res.dara_dataType %}
            <dataTypes>
                <dataType>
                    <language>en</language>
                    <freetext>{{ res.dara_dataType }}</freetext>
                </dataType>
            </dataTypes>
        {% endif %}
        {% if res.url_type and res.url_type == "upload" %}
            {% set fileinfo = h.fileinfo(res) %}
            <files>
                <file>
                    <name>{{ fileinfo.filename }}</name>
                    <format>{{ res.format }}</format>
                    <size>{{ fileinfo.filesize }}</size>
                </file>
            </files>
        {% endif %}
    </dataSet>
</dataSets>

{# 27. note #}
{{ macros.note(res.dara_note) or None }}



{# 31. relation #}
{# 'IsPartOf' references the collection (in our case) #}
{# we need the container element here because the macro only creates single
relations since collection do need to refer to more than one resource #}
<relations>
{{ macros.relation('DOI', h.pkg_doi(pkg), 'IsPartOf') }}
</relations>


</resource>


